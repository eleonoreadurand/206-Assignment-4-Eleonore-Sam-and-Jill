---
title: "assignment 4 test"
author: "Eleonore Durand, Sam Smith, Jill Wirt"
date: "November 21, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE}

#Load packages

library(tidyverse)
library(vcdExtra)
library(car)
library(onewaytests)
library(kableExtra)
library(ggsignif)

#Read in original (untidy) data files

lobster_ab <- read_csv("lobster_size_abundance.csv")
traps<- read_csv("lobster_traps.csv")



```

Other things to do/consider:
1. Boxplots
2. Incorporating absolute differences to talk about for some of the tests
3. Look at facet wrap unfinished graphs for #3- not positive all are "normal"-- maybe run a mann-whitney test for this one and t-tests (student's or welch's) for the others??
4. Error bars and letters over the bars in the graphs in #2?
5. Figure captions ALL
5. Means table for ANOVA (#2, reference example online)

```{r}

#1. : data wrangling for abundance


#Create tidy DF for just 2017 lobster values
lobster_data <- as.data.frame(lobster_ab) %>% 
  expand.dft(freq="COUNT") %>% 
  filter(YEAR == "2017")

#Create tidy DF.
lobster_tidy<- as.data.frame(lobster_ab) %>% 
  expand.dft(freq="COUNT")  

#Create tidy DF, then create a table that shows means and variances 
lobster_new <- as.data.frame(lobster_ab) %>% 
  expand.dft(freq="COUNT") %>% 
  filter(YEAR == "2017") %>% 
  group_by(SITE) %>% 
  summarize(
    mean_lobster_size = round(mean(SIZE), 1),
    var_lobster_size=round(var(SIZE))
  )


#Create an abundance table
lobster_ab_trend <- as.data.frame(lobster_ab) %>% 
  expand.dft(freq="COUNT") %>% 
  count(YEAR, SITE) %>% 
  spread(SITE, n) %>% 
  select(-YEAR)


#Re-name rownames within the table to make it useable for chi-square tests, etc
rownames(lobster_ab_trend)<- c ("2012", "2013", "2014", "2015", "2016", "2017")

#View table
lobster_ab_trend

#Making the table pretty:
ab_table_pretty <- lobster_ab_trend %>% 
  kable(align= "c", col.names = c("Arroyo Quemado", "Naples Reef", "Mohawk Reef", "Isla Vista", "Carpinteria")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE) %>% 
  add_header_above(c("", "Lobster Count at Sites, 2012-2017 "=5), escape= FALSE)

ab_table_pretty


#Creating a graph for lobster abundance
ab_scatter<- as.data.frame(lobster_ab) %>% 
  expand.dft(freq="COUNT") %>% 
  count(YEAR, SITE) %>% 
  ggplot(aes(x= YEAR, y=n)) +
  geom_line(aes(color=SITE), size=0.5) +
  theme_classic()+ 
  scale_y_continuous(breaks= seq(0,750, by= 100), expand= c(0,0))+
  labs(x= "Year", y= "Lobster abdundance")+
  ggtitle("Variations in Lobster Abundance, 2012-2017")
  

ab_scatter

#1, Part 2 (Pressure on )

pressure_tidy<- as.data.frame(traps) %>% 
  expand.dft(freq="TRAPS")

#Pressure table
pressure_trend <- as.data.frame(traps) %>% 
  expand.dft(freq="TRAPS") %>%
  count(YEAR, SITE) %>% 
  spread(SITE, n) %>% 
  select(-YEAR) %>% 
  mutate(IVEE= 0, NAPL=0) %>% #used mutate to show that 2 sites didn't have traps
  select("ABUR", "AHND", "AHND to AQUE", "AQUE", "CARP", "GOLB", "IVEE", "MOHK", "NAPL")

rownames(pressure_trend)<- c ("2012", "2013", "2014", "2015", "2016", "2017")
#adds back in the year as row names

pressure_trend

#Make the table look good #missing 3 site names!!

pressure_table_pretty <- pressure_trend %>% 
  kable(align= "c", col.names = c("Arroyo Quemado", "Carpinteria", "Goleta Beach", "Isla Vista", "Mohawk Reef", "Naples Reef")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE) %>% 
  add_header_above(c("", "Lobster Count at Sites, 2012-2017 "=5), escape= FALSE)

pressure_scatter<- as.data.frame(traps) %>% 
  expand.dft(freq="TRAPS") %>% 
  count(YEAR, SITE) %>% 
  ggplot(aes(x= YEAR, y=n)) +
  geom_line(aes(color= SITE)) +
  geom_point() +
  scale_y_continuous(breaks= seq(0,1400, by= 200), expand= c(0,0))+
  theme_classic()+
  labs(x= "Year", y= "Number of traps")+
  ggtitle("Lobster Fishing Pressure, 2012-2017")
  
pressure_scatter


```

```{r}

#Problem 2. 

#First- we think we want to do an ANOVA. So, we will do the Levene's Test to test for equal variances.

lobster_levene <-leveneTest(SIZE ~ SITE, data=lobster_data)
lobster_levene

#Result of Levene's test: variances are NOT equal, BUTTTTT largest variance is less than 4times the smallest variance, so we can still do ANOVA. Yay!

#Next step: more prep for showing the ANOVA in our results

#1. Make stacked DF

set.seed(24)
ReachA <- rnorm(24, mean = 0.4, sd = 0.15)
set.seed(24)
ReachB <- rnorm(24, mean = 0.8, sd = 0.1)
set.seed(24)
ReachC <- rnorm(24, mean = 0.9, sd = 0.2)
set.seed(24)
ReachD <- rnorm(24, mean = 0.95, sd = 0.2)

df <- data.frame(ReachA, ReachB, ReachC, ReachD) #how do we know the order?
stack_df <- stack(df)
colnames(stack_df) <- c("site","size")

#2. Run one-way ANOVA

#ANOVA overview:
#single factor: SITE
#levels of factor: 5
#single variable: SIZE

lobster_aov <- aov(SIZE ~ SITE, data=lobster_data)
summary(lobster_aov)

#post hoc testing- let's do Tukey's HSD.
lobster_ph <- TukeyHSD(lobster_aov)

lobster_ph

#3. Make ANOVA table

aov_table <- xtable(lobster_aov, caption = 'Mean lobster size ANOVA results summary.')
print(table, comment = FALSE, caption.placement = "top")

aov_summary <- stack_df %>% 
  group_by(reach) %>% 
  summarize(Mean = round(mean(density),2), SD = round(sd(density),2))

#4. Make column graph with error bars and letter differences to show ANOVA results

aov_graph <- ggplot(lobster_aov, aes(x = SITE, y = SIZE)) +
  geom_col(colour = NA, fill = "gray50", width = 0.5) +
  geom_errorbar(aes(ymax = Mean + SD, ymin = Mean - SD), width = 0.1) +
  scale_y_continuous(expand = c(0,0), limits = c(0,1.2)) +
  labs(y=expression(Mean~Lobster~Size(mm))) +
  scale_x_discrete(labels = c("Isla Vista","Carpinteria","Mohawk","Naples","Arroyo Quemado")) +
  xlab("\nSite")

  
aov_graph

```

```{r}

#Part 3. 

#to-do list: create grouped column graphs for each site!

#Ideas: 
# A.ANOVA- nope, dont do this. We are only testing by site, so it's two groups exactly

# B. T-tests- yes, do this! We are comparing the two years at each SITE. Then, in the results/discussion, talk about the significant or not-signifcant differences between the MPA sites and the non-MPA sites.

#Note: should run an F-test for each site first!!
# Why? To determine whether or not to run a Student's t-test (equal variances) or a Welch's Two Sample (unequal variances). Remember, the default is Welch's unequal variances, but the Student's T-test is more powerful/robust.
 


```




```{r}

##4. Chi-square test for proportions.

#A. Create a new table (df?) to make yes/no columns for if each lobster is bigger or smaller than the minimum   
#B. Create a contingency table that's "useable" for chi-square tests to compare proportions.
#C. make the contigency table look good to present in paper.
#D. Run the chi-square!

#to-do: make the contigency table look good to present in paper.

legal_size <- lobster_data %>%
    mutate(
     SIZE = case_when(
      SIZE <= 82.6 ~ "no", 
      SIZE > 82.6 ~ "yes"
    )
  ) %>%
  count(SIZE, lobster_data) %>%
  spread(lobster_data) %>%
  select(-YEAR) 

row_names

# B. Make the table look pretty, use kable

# C. Make the prop table
prop2_lob <- prop.table(as.matrix(prep_prop_lob), 1)

#D. Run the chi-square test.



 
```

